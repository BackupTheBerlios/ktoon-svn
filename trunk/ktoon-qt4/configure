#/bin/bash

. scripts/global

CONFIGURE_TEST_DIR=configure.tests
FAIL=-1
SUCC=0
CONFIG_H=config.h
CONFIG_LOG=$(pwd)/$LOG_FILE

# $1 parameter is a text
# $2 directory 
function check()
{
	RESULT="yes."
	if [ -d $CONFIGURE_TEST_DIR/$2 ]
	then
		cd $CONFIGURE_TEST_DIR/$2
		$QMAKE 2>> $CONFIG_LOG >> $CONFIG_LOG
		${MAKE} 2>>$CONFIG_LOG >>$CONFIG_LOG || RESULT="no."
		cd - 2>> /dev/null >> /dev/null
	else
		RESULT="no."
	fi
	
	qpinfo "Checking for $1... $RESULT" -n
	
	if [ ${RESULT} != "yes." ]
	then
		return $FAIL
	fi
	
	return $SUCC
}

function defineMacro()
{
	echo "#define $1" >> $CONFIG_H
}

function usage()
{
	echo "Use $0 [options]"
	echo
	echo "Options: "
	echo "		-k,--enable-ktoonstyle	Enables KToonStyle"
	echo "		--enable-kinas 		Enable KINAS"
	echo
	exit 0;
}

echo "/* Generated automatically by configure script */" > $CONFIG_H 

TEMP=`getopt -o kh:: --long help,enable-ktoonstyle,enable-kinas:: -n "$0" -- "$@"`

eval set -- "$TEMP"
while [ true ]
do
        case "$1" in
		-h|--help) usage; shift;;
		-k|--enable-ktoonstyle) defineMacro ENABLE_KTOONSTYLE; shift ;;
		--enable-kinas) defineMacro ENABLE_KINAS; shift ;;
		--) shift ; break ;;
		*) break;
	esac
done

detectQtVersion

ln -fs $(pwd)/$CONFIG_H $(pwd)/src/ktoonlib/$CONFIG_H

LIBS=''

check "aspell" aspell && LIBS="$LIBS -laspell" && defineMacro HAVE_ASPELL
#check "sound" sound && LIBS="$LIBS -laudio" && defineMacro HAVE_SOUND
check "gif" gif && LIBS="$LIBS -lgif" && defineMacro HAVE_LIBGIF
check "ffmpeg 0.4.9" ffmpeg && LIBS="$LIBS -lavcodec -lavformat" && defineMacro HAVE_FFMPEG
check "ming" ming && LIBS="$LIBS -lming" && defineMacro HAVE_MING

if [ "$LIBS" != '' ]
then
	echo "LIBS += $LIBS" > $KT_CONFIG
else
	echo > $KT_CONFIG
fi

echo
echo "**************************************"
qpwarn "$APPNAME is configured, if you want to clean configuration, execute \'make -f Makefile.common confclean\'"
echo "**************************************"
echo

